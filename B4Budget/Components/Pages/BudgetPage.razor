@page "/"
@using B4Budget.Models
@using B4Budget.Services
@inject IBudgetService BudgetService
@inject ICalculationService CalcService

<PageTitle>Budget</PageTitle>

@if (_isLoading)
{
	<p>Loading...</p>
}

else if (_budget is null)
{
	<!-- First Budget -->
	<div>
		<h2>Welcome to B4Budget</h2>
		<p>Create your first budget to get started.</p>
		<div>

			<!-- Set Budget Name -->
			<label>
				Name:
				<input type="text" @bind="_newName"/>
			</label>

			<!-- Set Start Month -->
			<label>
				Start month:
				<select @bind="_newStartMonth">
					@for (var month = 1; month <= 12; month++)
					{
						<option value="@month">
							@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(month)
						</option>
					}
				</select>
			</label>

			<!-- Set Start Year -->
			<label>
				Start year:
				<input type="number" @bind="_newStartYear"/>
			</label>

			<!-- Create Budget Button -->
			<button @onclick="CreateFirstBudget">Create Budget</button>

		</div>
	</div>
}
else
{
	<!-- Main Grid -->
	<h2>Your Budget</h2>
	<BudgetGrid Budget="_budget" OnEntryChanged="ReloadBudget" />
}

@code {
	private Budget? _budget;
	private bool _isLoading = true;

	// New budget form fields
	private string _newName = $"{DateTime.Now.Year} Budget";
	private int _newStartMonth = 1;
	private int _newStartYear = DateTime.Now.Year;

	protected override async Task OnInitializedAsync() => await LoadBudget();

	private async Task LoadBudget()
	{
		_isLoading = true;
		_budget = await BudgetService.GetActiveBudgetAsync();
		_isLoading = false;
	}

	private async Task CreateFirstBudget()
	{
		await BudgetService.CreateBudgetAsync(_newName, _newStartMonth, _newStartYear);
		await LoadBudget();
	}

	private async Task ReloadBudget()
	{
		// Reloads budget after exit
		_budget = await BudgetService.GetActiveBudgetAsync();
		StateHasChanged();
	}
}